<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tipografias EAD Font Catalogue</title>
  <style>
    body { font-family: sans-serif; margin: 2em; background: #faf9f6; color: #222; }
    h1 { font-size: 2em; margin-bottom: 1em; }
    .controls, .filters {
      margin-bottom: 2em;
      padding: 1em;
      background: #e6f0f7;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 1.5em;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .controls {
      top: 0;
      backdrop-filter: blur(8px);
    }
    .filters {
      top: 4.5em;
      margin-bottom: 2.5em;
      backdrop-filter: blur(8px);
    }
    .controls label, .filters label { margin-right: 0.4em; white-space: nowrap; }
    .filters select { min-width: 120px; }
    .year-block { margin-bottom: 2.5em; }
    .year-title { font-size: 1.5em; margin-bottom: 0.6em; color: #1b4366; border-bottom: 2px solid #b1d0e0; }
    .author-block { margin-bottom: 1.3em; margin-left: 1.5em; }
    .author-title { font-size: 1.17em; font-weight: 600; margin-bottom: 0.4em; color: #1a273a; }
    .font-list {
      margin-left: 1.5em;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1em 2em;
      align-items: stretch;
      width: 100%;
      box-sizing: border-box;
    }
    .font-list.single-column {
      grid-template-columns: 1fr !important;
      margin-left: 0;
    }
    @media (max-width: 900px) {
      .font-list { grid-template-columns: 1fr; }
    }
    .font-item {
      background: #fff;
      border-radius: 7px;
      box-shadow: 0 1px 4px #0001;
      padding: 0.7em 1em;
      margin-bottom: 0.7em;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
      overflow-x: auto;
    }
    .font-item.single-column {
      width: 100%;
      max-width: none;
      box-sizing: border-box;
    }
    .font-name { font-weight: bold; }
    .font-link, .specimen-link { display: inline-block; margin-right: 1em; margin-bottom: 3px; }
    .font-tags { font-size: 0.91em; color: #475; margin-top: 0.3em; }
    .font-tag { background: #e1f3d8; border-radius: 4px; padding: 1px 7px; margin-right: 0.4em; }
    .font-preview {
      display: block;
      margin-top: 0.5em;
      margin-bottom: 0.5em;
      font-size: 1.5em;
      background: #fff;
      color: #262626;
      padding: 0.4em 0.8em;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s, font-size 0.2s, letter-spacing 0.2s;
      white-space: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      text-overflow: unset;
      outline: none;
      min-height: 2.2em;
      cursor: text;
      max-width: 100%;
    }
    .specimen-thumb { display: inline-block; vertical-align: middle; max-width: 120px; max-height: 90px; margin-right: 0.8em; margin-top: 0.4em; border-radius: 4px; box-shadow: 0 1px 4px #0002; background: #fff; object-fit: contain; }
    .placeholder-thumb {
      opacity: 0.4;
      filter: grayscale(1);
      background: #eee;
      border: 1px dashed #bbb;
    }
  </style>
</head>
<body>
  <h1>Tipografias EAD Font Catalogue</h1>
  <div class="controls">
    <label>
      Font color:
      <input type="color" id="fontColor" value="#262626">
    </label>
    <label>
      Background color:
      <input type="color" id="bgColor" value="#ffffff">
    </label>
    <label>
      Font size:
      <input type="range" id="fontSize" min="12" max="120" value="24">
      <span id="fontSizeValue">24</span>px
    </label>
    <label>
      Letter spacing:
      <input type="range" id="letterSpacing" min="0" max="1" step="0.01" value="0">
      <span id="letterSpacingValue">0</span>em
    </label>
  </div>
  <div class="filters">
    <label>
      Filter by year:
      <select id="yearFilter">
        <option value="">All years</option>
      </select>
    </label>
    <label>
      Filter by tag:
      <select id="tagFilter">
        <option value="">All tags</option>
      </select>
    </label>
    <label>
      Filter by teacher:
      <select id="teacherFilter">
        <option value="">All teachers</option>
        <option value="Manuel F. Sanfuentes">Manuel F. Sanfuentes</option>
        <option value="Alejandro Garretón">Alejandro Garretón</option>
        <option value="Andrea Torres">Andrea Torres</option>
      </select>
    </label>
  </div>
  <div id="output"></div>
  <script type="module">
    import fonts from './catalogue.js';

    const PLACEHOLDER_THUMB = "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";

    function groupFonts(fontsArr) {
      const years = {};
      fontsArr.forEach(entry => {
        if (!years[entry.year]) years[entry.year] = {};
        if (!years[entry.year][entry.author]) years[entry.year][entry.author] = [];
        years[entry.year][entry.author].push(entry);
      });
      return years;
    }

    function isPdf(file) {
      return typeof file === "string" && file.toLowerCase().endsWith('.pdf');
    }
    function isImage(file) {
      return typeof file === "string" && /\.(png|jpe?g)$/i.test(file);
    }

    function getSpecimenImage(specimen) {
      // Return the first image (png/jpg/jpeg) in specimen, or null
      if (!specimen) return null;
      if (Array.isArray(specimen)) {
        for (const s of specimen) {
          if (isImage(s)) return s;
        }
      } else if (isImage(specimen)) {
        return specimen;
      }
      return null;
    }

    function makeSpecimenDisplay(specimen, fontName = "") {
      const img = getSpecimenImage(specimen);
      if (img) {
        return `<img class="specimen-thumb" src="${img}" alt="Specimen for ${fontName}" title="Specimen for ${fontName}">`;
      } else {
        // Always show placeholder if no specimen image
        return `<img class="specimen-thumb placeholder-thumb" src="${PLACEHOLDER_THUMB}" alt="No specimen for ${fontName}" title="No specimen for ${fontName}">`;
      }
    }

    function makePdfDisplay(specimen, fontName = "") {
      // Only show PDF link if there's a PDF
      if (!specimen) return '';
      if (Array.isArray(specimen)) {
        return specimen.filter(isPdf).map(pdf => `<a class="specimen-link" href="${pdf}" target="_blank" rel="noopener">PDF specimen: ${fontName || pdf.split('/').pop()}</a>`).join(' ');
      } else if (isPdf(specimen)) {
        return `<a class="specimen-link" href="${specimen}" target="_blank" rel="noopener">PDF specimen: ${fontName || specimen.split('/').pop()}</a>`;
      }
      return '';
    }

    function makeTags(tags) {
      if (!tags || tags.length === 0) return '';
      return `<span class="font-tags">${tags.map(tag => `<span class="font-tag">${tag}</span>`).join('')}</span>`;
    }

    function registerFont(fontFile, fontName, uniqueSuffix) {
      const fontId = `Font_${fontName.replace(/\W+/g, '')}_${uniqueSuffix}`;
      if (document.getElementById(fontId)) return fontId;
      const style = document.createElement('style');
      style.id = fontId;
      style.textContent = `
        @font-face {
          font-family: '${fontId}';
          src: url('${fontFile}');
        }
      `;
      document.head.appendChild(style);
      return fontId;
    }

    function extractYearsAndTags(fontsArr) {
      const yearSet = new Set();
      const tagSet = new Set();
      fontsArr.forEach(f => {
        yearSet.add(f.year);
        (f.tags || []).forEach(tag => tagSet.add(tag));
      });
      return {years: Array.from(yearSet).sort(), tags: Array.from(tagSet).sort()};
    }

    function filterFonts(fontsArr, year, tag, teacher) {
      return fontsArr.filter(f => {
        const yearMatch = !year || f.year === year;
        const tagMatch = !tag || (f.tags && f.tags.includes(tag));
        const teacherMatch = !teacher || (f.teacher === teacher);
        return yearMatch && tagMatch && teacherMatch;
      });
    }

    // Controls
    const fontColor = document.getElementById('fontColor');
    const bgColor = document.getElementById('bgColor');
    const fontSize = document.getElementById('fontSize');
    const fontSizeValue = document.getElementById('fontSizeValue');
    const letterSpacing = document.getElementById('letterSpacing');
    const letterSpacingValue = document.getElementById('letterSpacingValue');
    const yearFilter = document.getElementById('yearFilter');
    const tagFilter = document.getElementById('tagFilter');
    const teacherFilter = document.getElementById('teacherFilter');
    const output = document.getElementById('output');
    let previewStyles = {
      color: fontColor.value,
      background: bgColor.value,
      fontSize: fontSize.value + 'px',
      letterSpacing: letterSpacing.value + 'em',
    };

    function populateFilters(fontsArr) {
      const {years, tags} = extractYearsAndTags(fontsArr);
      yearFilter.innerHTML = `<option value="">All years</option>` + 
        years.map(y => `<option value="${y}">${y}</option>`).join('');
      tagFilter.innerHTML = `<option value="">All tags</option>` + 
        tags.map(t => `<option value="${t}">${t}</option>`).join('');
    }

    function renderCatalogue(filteredFonts) {
      output.innerHTML = '';
      const years = groupFonts(filteredFonts);
      Object.keys(years).sort().forEach(year => {
        const yearDiv = document.createElement('div');
        yearDiv.className = 'year-block';
        yearDiv.innerHTML = `<div class="year-title">${year}</div>`;
        Object.keys(years[year]).sort().forEach(author => {
          const authorDiv = document.createElement('div');
          authorDiv.className = 'author-block';
          authorDiv.innerHTML = `<div class="author-title">${author}</div>`;
          const fontEntries = years[year][author].filter(e => e.file || e.name || e.specimen);
          if (fontEntries.length === 0) return;
          const fontList = document.createElement('div');
          fontList.className = 'font-list';
          if(fontEntries.length === 1) fontList.classList.add('single-column');
          fontEntries.forEach((font, idx) => {
            const fontDiv = document.createElement('div');
            fontDiv.className = 'font-item';
            if(fontEntries.length === 1) fontDiv.classList.add('single-column');
            let preview = '';
            if (font.file && (font.file.endsWith('.otf') || font.file.endsWith('.ttf'))) {
              const fam = registerFont(font.file, font.name || 'Font', year + author + idx);
              preview = `<span class="font-preview" contenteditable="true"
                spellcheck="false"
                style="font-family: '${fam}', sans-serif; color: ${previewStyles.color}; background: ${previewStyles.background}; font-size: ${previewStyles.fontSize}; letter-spacing: ${previewStyles.letterSpacing};"
                >The quick brown fox jumps over the lazy dog. 1234567890</span>`;
            }
            fontDiv.innerHTML = `
              ${font.name ? `<span class="font-name">${font.name}</span><br>` : ''}
              ${preview}
              ${font.file ? `<a class="font-link" href="${font.file}" download>Download font</a><br>` : ''}
              ${makeSpecimenDisplay(font.specimen, font.name)}
              ${makePdfDisplay(font.specimen, font.name)}
              ${makeTags(font.tags)}
            `;
            fontList.appendChild(fontDiv);
          });
          authorDiv.appendChild(fontList);
          yearDiv.appendChild(authorDiv);
        });
        output.appendChild(yearDiv);
      });
    }

    populateFilters(fonts);
    renderCatalogue(fonts);

    function updatePreviews() {
      previewStyles.color = fontColor.value;
      previewStyles.background = bgColor.value;
      previewStyles.fontSize = fontSize.value + 'px';
      previewStyles.letterSpacing = letterSpacing.value + 'em';
      fontSizeValue.textContent = fontSize.value;
      letterSpacingValue.textContent = letterSpacing.value;
      document.querySelectorAll('.font-preview').forEach(el => {
        el.style.color = previewStyles.color;
        el.style.background = previewStyles.background;
        el.style.fontSize = previewStyles.fontSize;
        el.style.letterSpacing = previewStyles.letterSpacing;
      });
    }
    fontColor.addEventListener('input', updatePreviews);
    bgColor.addEventListener('input', updatePreviews);
    fontSize.addEventListener('input', updatePreviews);
    letterSpacing.addEventListener('input', updatePreviews);

    function applyFilters() {
      const year = yearFilter.value;
      const tag = tagFilter.value;
      const teacher = teacherFilter.value;
      const filtered = filterFonts(fonts, year, tag, teacher);
      renderCatalogue(filtered);
      updatePreviews();
    }
    yearFilter.addEventListener('change', applyFilters);
    tagFilter.addEventListener('change', applyFilters);
    teacherFilter.addEventListener('change', applyFilters);

  </script>
</body>
</html>